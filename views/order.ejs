<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title> speed</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ§‹</text></svg>">
  <link rel="stylesheet" href="css/order.css">
</head>
<body>
  <header>
    <nav class="navbar">
      <ul class="nav-links">
        <li><a href="/homepage">é¦–é </a></li>
        <li><a href="/menu">èœå–®</a></li>
        <li><a href="/order">ç·šä¸Šè¨‚è³¼</a></li>
        <li><a href="/storepage">é–€å¸‚æ“šé»</a></li>
        <li><a href="/brandStory" class="active">å“ç‰Œæ•…äº‹</a></li>
        <li><a href="/frequentlyaskedquestions">å¸¸è¦‹å•é¡Œ</a></li>

        <% if (user) { %>
          <li><a onclick="return false;">æ­¡è¿ <%= user.username %></a></li>
          <li><a href="/logout">ç™»å‡º</a></li>
          <% } else { %>
            <li><a href="/login">ç™»å…¥</a></li>
            <% } %>
      </ul>

      <div class="hamburger">
        <span></span><span></span><span></span>
      </div>
    </nav>
  </header>

  <main>
    <section class="hero">
      <h1>ç·šä¸Šè¨‚è³¼</h1>
    </section>

    <section class="container">
      <!-- å•†å“å€ -->
      <div class="products" id="products"></div>

      <!-- è³¼ç‰©è»Š -->
      <aside class="cart"> <!-- ç”¨æ–¼å´é‚Šå…§å®¹ï¼Œé€šå¸¸æ˜¯è¼”åŠ©è³‡è¨Š -->
        <h3>è³¼ç‰©è»Š</h3>
        <ul id="cartList"></ul>
        <p>ç¸½é‡‘é¡ï¼šNT$ <span id="total">0</span></p> <!-- ç”¨ JS æ›´æ–°æ•¸å­—ï¼Œä¾‹å¦‚è³¼è²·å•†å“å¾Œé‡‘é¡å¢åŠ  -->

        <div class="checkout">
          <input type="text" id="name" placeholder="å§“å" /> <!-- ç•¶è¼¸å…¥æ¡†æ˜¯ç©ºçš„æ™‚å€™ï¼Œæœƒåœ¨æ¡†å…§é¡¯ç¤ºç°è‰²æ–‡å­—ï¼Œæç¤ºä½¿ç”¨è€…æ‡‰è©²åœ¨é€™è£¡è¼¸å…¥ä»€éº¼ -->
          <input type="tel" id="phone" placeholder="é›»è©±" /> <!-- ç•¶è¼¸å…¥æ¡†æ˜¯ç©ºçš„æ™‚å€™ï¼Œæœƒåœ¨æ¡†å…§é¡¯ç¤ºç°è‰²æ–‡å­—ï¼Œæç¤ºä½¿ç”¨è€…æ‡‰è©²åœ¨é€™è£¡è¼¸å…¥ä»€éº¼ -->
          <select id="pickup">
            <option value="">å–é¤æ–¹å¼</option> <!-- åœ¨ HTML <input> æˆ– <textarea> è£¡ï¼Œvalue å±¬æ€§ç”¨ä¾†è¨­å®š æ¬„ä½çš„åˆå§‹å€¼ï¼Œä¹Ÿå°±æ˜¯è¡¨å–®ä¸€é–‹å§‹çš„å…§å®¹-->
            <option>é–€å¸‚è‡ªå–</option>
            <option>å¤–é€</option>
          </select>
          <button onclick="submitOrder()">é€å‡ºè¨‚å–®</button>
        </div>
      </aside>
    </section>
  </main>

  <footer>
    Â© 2025 é£²æ–™åº—ç·šä¸Šè¨‚è³¼ç³»çµ±
  </footer>

  <script>
    const products = [ /* const è¡¨ç¤ºè®Šæ•¸ä¸èƒ½é‡æ–°æŒ‡æ´¾æ•´å€‹é™£åˆ—ï¼Œä½†å¯ä»¥ä¿®æ”¹é™£åˆ—è£¡çš„å…§å®¹ã€‚ */
      { name: 'æœˆå…‰ç«ç‘°', price: { M: 90, L: 110 }, img: '/img/order-img/1moonlight_rose.png' },
      { name: 'æ™¨éœ²æª¸æª¬', price: { M: 85, L: 100 }, img: '/img/order-img/2morning_lemon.png' },
      { name: 'é›²ç«¯ç„¦ç³–', price: { M: 95, L: 115 }, img: '/img/order-img/3cloud_caramel.png' },
      { name: 'æ˜Ÿé›²è“æœ', price: { M: 100, L: 120 }, img: '/img/order-img/4nebula_berry.png' },
      { name: 'æœˆå½±æŠ¹èŒ¶', price: { M: 100, L: 120 }, img: '/img/order-img/5moonlight_matcha.png' },
      { name: 'ç„¦ç³–é›²æœµ', price: { M: 95, L: 110 }, img: '/img/order-img/6caramel_cloud.png' },
      { name: 'æ˜ŸèªèŒ‰è‰', price: { M: 90, L: 110 }, img: '/img/order-img/7star_jasmine.png' },
      { name: 'ç¥ç€çƒé¾', price: { M: 85, L: 100 }, img: '/img/order-img/8amber_oolong.png' },
      { name: 'éœ§ä¹‹è“èª', price: { M: 95, L: 115 }, img: '/img/order-img/9fog_berry.png' },
      { name: 'æ˜Ÿéœ§å¥¶é¦™', price: { M: 95, L: 110 }, img: '/img/order-img/10star_fog_milk.png' },
      { name: 'æ™¨æ›¦èœœæ¡ƒ', price: { M: 85, L: 100 }, img: '/img/order-img/11morning_peach.png' },
      { name: 'æœˆç´—èŠ±èª', price: { M: 90, L: 110 }, img: '/img/order-img/12moon_fog_flower.png' },
      { name: 'æš®å…‰æ‘©å¡', price: { M: 110, L: 130 }, img: '/img/order-img/13moonlight_mocha.png' },
      { name: 'æ˜Ÿå¤œæ‹¿éµ', price: { M: 115, L: 135 }, img: '/img/order-img/14star_night_latte.png' },
      { name: 'æœˆå½±å¡å¸ƒå¥‡è«¾', price: { M: 120, L: 140 }, img: '/img/order-img/15moonlight_cappuccino.png' },
      { name: 'æ˜Ÿè½ç™½ç‰å¥¶èŒ¶', price: { M: 95, L: 115 }, img: '/img/order-img/16star_fog_milk.png' },
      { name: 'éœ²æ™¨é’æª¸æ°£æ³¡', price: { M: 85, L: 100 }, img: '/img/order-img/17morning_lemon_bubble.png' },
      { name: 'æœˆéœœç¥ç€ç´…èŒ¶', price: { M: 90, L: 110 }, img: '/img/order-img/18moon_fog_amber_tea.png' },
      { name: 'æ˜Ÿç©ºç‰ç’ƒ', price: { M: 95, L: 115 }, img: '/img/order-img/19star_luminous.png' },
      { name: 'æœˆæ³‰ç™½éœœ', price: { M: 90, L: 110 }, img: '/img/order-img/20moon_fog_white.png' },
      { name: 'æ›¦å…‰è“èª', price: { M: 100, L: 120 }, img: '/img/order-img/21morning_berry.png' },
      { name: 'æ˜Ÿæ¾ˆé›²æ³¡', price: { M: 95, L: 115 }, img: '/img/order-img/22star_cloud_bubble.png' },
      { name: 'æœˆéœ§é›ªé ‚', price: { M: 105, L: 125 }, img: '/img/order-img/23moon_fog_snow.png' },
      { name: 'æ›¦å…‰æ°£æ³¡', price: { M: 90, L: 110 }, img: '/img/order-img/24morning_bubble.png' }
    ];
    /* ä¸Šé¢æ¯å€‹å…ƒç´ æ˜¯ç‰©ä»¶ï¼ŒåŒ…å« nameã€priceã€img */
    /* å¯ä»¥ç”¨ JS å‹•æ…‹ç”Ÿæˆç¶²é å•†å“åˆ—è¡¨æˆ–çµå¸³åŠŸèƒ½ */

    let cart = []; /* å‰µå»ºä¸€å€‹ç©ºé™£åˆ— cartï¼Œç”¨ä¾†å„²å­˜åŠ å…¥è³¼ç‰©è»Šçš„å•†å“ */
    const productDiv = document.getElementById('products');

    products.forEach((p, i) => { /* æ¯å€‹å•†å“ç‰©ä»¶ç”¨ p è¡¨ç¤ºï¼Œç´¢å¼•ç”¨ i */
      productDiv.innerHTML += `
        <div class="card">
          <img src="${p.img}"> <!-- ${p.img}é€™æ˜¯ JavaScript çš„æ¨¡æ¿å­—ä¸²èªæ³•ã€‚ï¼Œ${p.img} æœƒè¢«æ›¿æ›æˆè®Šæ•¸ p.img çš„å€¼ã€‚ -->
          <div class="info">
            <h4>${p.name}</h4>
            <p>M: NT$ ${p.price.M} / L: NT$ ${p.price.L}</p>

            <div class="form-group">
              <label>å°ºå¯¸ï¼š</label>
              <select id="size-${i}">
                <option value="M">M</option>
                <option value="L">L</option>
              </select>
            </div>

            <div class="form-group">
              <label>æ•¸é‡ï¼š</label>
              <input type="number" id="qty-${i}" value="1" min="1"> <!-- åˆå§‹å€¼ 1ï¼Œæœ€å°å€¼ 1-->
            </div>

            <div class="form-group">
              <label>å†°å¡Šï¼š</label>
              <select id="ice-${i}">
                <option>æ­£å¸¸å†°</option>
                <option>å°‘å†°</option>
                <option>å»å†°</option>
              </select>
            </div>

            <div class="form-group">
              <label>ç”œåº¦ï¼š</label>
              <select id="sugar-${i}">
                <option>æ­£å¸¸ç³–</option>
                <option>åŠç³–</option>
                <option>å¾®ç³–</option>
                <option>ç„¡ç³–</option>
              </select>
            </div>

            <button onclick="addToCart(${i})">åŠ å…¥è³¼ç‰©è»Š</button>
          </div>
        </div>
      `;
    });

    function addToCart(i) { /* i æ˜¯ å•†å“åœ¨ products é™£åˆ—è£¡çš„ç´¢å¼•å€¼ */
      const p = products[i];

      const size = document.getElementById(`size-${i}`).value; /* å›å‚³çš„å°±æ˜¯å­—ä¸² "M" æˆ– "L" */
      const qty = Math.max(1, parseInt(document.getElementById(`qty-${i}`).value, 10) || 1);
      /* Math.max(æœ€å°å…è¨±å€¼, ä½¿ç”¨è€…è¼¸å…¥çš„æ•¸é‡)ï¼Œç¢ºä¿æ•¸é‡ã€Œæœ€å°‘æ˜¯ 1ã€ï¼Œä¸å¯èƒ½è®Šæˆ 0 æˆ–è² æ•¸ */
      /* parseInt(..., 10) â†’ æŠŠè¼¸å…¥æ¡†çš„å€¼è½‰æˆæ•´æ•¸ï¼ŒparseInt(å­—ä¸², é€²ä½åˆ¶) */
      /* || 1 â†’ å¦‚æœä½¿ç”¨è€…è¼¸å…¥ç©ºçš„ã€éæ•¸å­—ï¼ˆNaNï¼‰ï¼Œå°±ç”¨ 1 */
      const ice = document.getElementById(`ice-${i}`).value;
      const sugar = document.getElementById(`sugar-${i}`).value;

      const price = Number(p.price[size]); /* ä¾ç…§ã€Œä½¿ç”¨è€…é¸çš„å°ºå¯¸ã€æ‹¿åˆ°ã€Œé‚£æ¯é£²æ–™å°æ‡‰å°ºå¯¸çš„å–®åƒ¹ã€ */
      /* Number() ä¿è­‰å®ƒæ˜¯æ•¸å­—å‹åˆ¥ */
      if (!Number.isFinite(price)) { /* å®ƒåªæœƒå›å‚³ å¸ƒæ—å€¼ï¼štrue â†’ æ˜¯æ­£å¸¸ã€æœ‰é™çš„æ•¸å­—ã€false â†’ ä¸æ˜¯ */
        alert('åƒ¹æ ¼è³‡æ–™æœ‰èª¤'); /* alert() æ˜¯ç€è¦½å™¨å…§å»ºå‡½å¼ï¼Œç”¨ä¾†è·³å‡ºè¨Šæ¯è¦–çª—çµ¦ä½¿ç”¨è€…çœ‹ã€‚ */
        return;
      }

      cart.push({ /* æ¯æ¬¡ä½¿ç”¨è€…æŒ‰ã€ŒåŠ å…¥è³¼ç‰©è»Šã€ï¼Œå°±æœƒåœ¨ cart é™£åˆ—è£¡å¤šä¸€å€‹ç‰©ä»¶ï¼š */
        name: p.name,
        size,
        qty,
        ice,
        sugar,
        price
      });
      /* é€™å€‹é™£åˆ—å°±æ˜¯è³¼ç‰©è»Šçš„ã€Œæ˜ç´°ã€ï¼Œä¹‹å¾Œå¯ä»¥ç”¨ä¾†è¨ˆç®—ç¸½é‡‘é¡æˆ–é€åˆ°å¾Œç«¯ã€‚ */

      renderCart();
      /* å‘¼å« renderCart() å°±æœƒï¼šæ¸…ç©º <ul id="cartList"> å…§å®¹ã€é‡æ–°æŠŠ cart é™£åˆ—è£¡çš„æ¯ä¸€å€‹å•†å“ç”Ÿæˆ HTML é¡¯ç¤ºå‡ºä¾†ã€è¨ˆç®—ç¸½é‡‘é¡ä¸¦æ›´æ–° <span id="total"> */
    }

    function renderCart() {
      const list = document.getElementById('cartList');
      list.innerHTML = ''; /* å…ˆæ¸…ç©ºè£¡é¢çš„å…§å®¹ï¼Œé¿å…æ¯æ¬¡åˆ·æ–°éƒ½é‡è¤‡ç–ŠåŠ  */
      let total = 0;

      cart.forEach((item, idx) => { /* idx = å•†å“åœ¨é™£åˆ—ä¸­çš„ç´¢å¼•ï¼Œç”¨ä¾†åˆªé™¤å•†å“æ™‚è¾¨è­˜å“ªä¸€å€‹ã€‚ */
        const subtotal = item.price * item.qty;
        total += subtotal;

        list.innerHTML += `
          <li>
            <div>
              <b>${item.name}</b>ï¼ˆ${item.size}ï¼‰x ${item.qty}<br>
              <small>${item.ice} / ${item.sugar}</small> <!-- <small> æ˜¯ HTML çš„æ¨™ç±¤ï¼Œç”¨ä¾†æŠŠæ–‡å­—é¡¯ç¤ºå¾—æ¯”ä¸€èˆ¬æ–‡å­—å°ä¸€é»ã€‚ -->
            </div>
            <div>
              NT$ ${subtotal}
              <button onclick="removeItem(${idx})">åˆªé™¤</button>
            </div>
          </li>
        `;
      });

      document.getElementById('total').innerText = total; /* æŠŠè³¼ç‰©è»Šç›®å‰çš„ç¸½é‡‘é¡é¡¯ç¤ºåœ¨é é¢ä¸Š */
    }

    function removeItem(idx) {
      cart.splice(idx, 1); /* splice() æ˜¯é™£åˆ—çš„æ–¹æ³•ï¼Œç”¨ä¾†åˆªé™¤æˆ–æ›¿æ›é™£åˆ—ä¸­çš„å…ƒç´ ã€‚ */
      /* splice(start, deleteCount)ï¼Œstart = å¾å“ªå€‹ç´¢å¼•é–‹å§‹ã€deleteCount = åˆªé™¤å¹¾å€‹å…ƒç´  */
      renderCart();
    }

    /* async æ˜¯ asynchronousï¼ˆéåŒæ­¥ï¼‰ çš„ç¸®å¯«ã€‚å®ƒç”¨åœ¨å‡½å¼å‰é¢ï¼Œè¡¨ç¤ºé€™å€‹å‡½å¼è£¡é¢å¯èƒ½æœƒæœ‰éœ€è¦ã€Œç­‰å¾…ã€çš„æ“ä½œï¼Œè€Œä¸æœƒé˜»å¡ç¨‹å¼åŸ·è¡Œã€‚ */
    async function submitOrder() {
      const nameEl = document.getElementById('name');
      const phoneEl = document.getElementById('phone');
      const pickupEl = document.getElementById('pickup');

      if (cart.length === 0) { alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); return }
      /*åªè¦åå­—ã€é›»è©±æˆ–å–è²¨æ–¹å¼æœ‰ä»»ä½•ä¸€å€‹æ¬„ä½æ˜¯ç©ºçš„ï¼ˆæˆ–åå­—/é›»è©±åªæœ‰ç©ºç™½ï¼‰ï¼Œå°±ä¸é€å‡ºè¨‚å–® */
      if (!nameEl.value.trim() || !phoneEl.value.trim() || !pickupEl.value) { /* trim() â†’ å»æ‰æ–‡å­—å‰å¾Œçš„ç©ºç™½ï¼ˆç©ºæ ¼ã€æ›è¡Œã€Tab ç­‰ï¼‰ */
        alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
        return;
      }
      const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
      /* é€™æ®µç¨‹å¼ç¢¼æ˜¯ è¨ˆç®—è³¼ç‰©è»Š cart è£¡æ‰€æœ‰å•†å“çš„ç¸½åƒ¹ */
      /* reduce() æ˜¯é™£åˆ—æ–¹æ³•ï¼Œç”¨ä¾†æŠŠé™£åˆ—è£¡çš„å…ƒç´ ã€Œç´¯åŠ ã€æˆä¸€å€‹å€¼ */


      /* payload æ˜¯ è¦é€çµ¦å¾Œç«¯ API çš„è¨‚å–®è³‡æ–™ */
      const payload = {
        customer_name: nameEl.value.trim(),
        phone: phoneEl.value.trim(),
        pickup_method: pickupEl.value,
        total,
        cart: cart.map(item => ({
          name: item.name,
          price: item.price
        })) /* å°±æ˜¯åœ¨ è¨˜éŒ„é€™å€‹å®¢æˆ¶è²·äº†å“ªäº›å•†å“ï¼ˆé€™è£¡æ˜¯é£²æ–™ï¼‰ä»¥åŠæ¯å€‹å•†å“çš„åƒ¹æ ¼ï¼Œç„¶å¾ŒæŠŠé€™äº›è³‡æ–™æ”¾åˆ° payload è£¡é€åˆ°å¾Œç«¯ */
      };

      console.log('payload total =', payload.total);

      /* await è¡¨ç¤ºã€Œç­‰å¾…é€™å€‹è«‹æ±‚å®Œæˆã€ï¼Œç„¶å¾Œæ‰ç¹¼çºŒåŸ·è¡Œä¸‹ä¸€è¡Œ */
      /* fetch() æ˜¯ç€è¦½å™¨æä¾›çš„ ç”¨ä¾†å‘å¾Œç«¯ API ç™¼é€è«‹æ±‚ çš„æ–¹æ³• */
      /* '/api/order' â†’ å¾Œç«¯æ¥æ”¶è¨‚å–®çš„ API è·¯å¾‘ */
      /* 'POST' â†’ ç”¨ POST æ–¹æ³•é€è³‡æ–™ï¼ŒPOST ç”¨åœ¨ã€Œæ–°å¢è³‡æ–™ã€æˆ–ã€Œé€è¡¨å–®ã€ */
      try {
        const res = await fetch('/api/order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload) /* JSON.stringify() â†’ æŠŠ JavaScript ç‰©ä»¶è½‰æˆ JSON å­—ä¸²ï¼Œæ‰èƒ½é€çµ¦å¾Œç«¯ */
        });

        /* æŠŠè¨‚å–®è³‡æ–™æ•´ç†å¥½ â†’ payload

          è½‰æˆ JSON å­—ä¸² â†’ JSON.stringify(payload)

          é€çµ¦ /api/order â†’ fetch

          ç­‰ä¼ºæœå™¨å›æ‡‰ â†’ await

          å›æ‡‰å­˜åˆ° res â†’ å¯ä»¥å†è§£æçµæœ */

        const data = await res.json(); /* æŠŠä¼ºæœå™¨å›å‚³çš„ JSON è³‡æ–™è§£ææˆ JavaScript ç‰©ä»¶ï¼Œç„¶å¾Œå­˜é€²è®Šæ•¸ data */
        alert(`è¨‚å–®æ–°å¢æˆåŠŸï¼è¨‚å–®ç·¨è™Ÿï¼š${data.order_id}`);

        cart = [];
        renderCart();
        nameEl.value = '';
        phoneEl.value = '';
        pickupEl.value = '';

      } catch (err) {
        console.error(err);
        alert('é€å‡ºå¤±æ•—ï¼šç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨');
      }
    }
  </script>
</body>
<script src="js/order.js"></script>
</html>
